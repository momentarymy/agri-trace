# 智慧农产品全链路溯源系统 - 开发规划文档

## 1. 项目技术架构
- **前端**: UniApp (Vue2/Vue3) -> 发布为 微信小程序 + H5 + App
- **后端**: Node.js + Express 框架
- **数据库**: MySQL 5.7 或 8.0
- **图片存储**: 本地静态资源目录 或 对象存储 (OSS)
- **工具库**: 
  - 前端: uView UI (推荐UI库), uQRCode (二维码生成), uCharts (图表)
  - 后端: Sequelize 或 TypeORM (ORM框架), jsonwebtoken (JWT鉴权), multer (文件上传)

## 2. 数据库设计规划 (核心表结构建议)

### A. 用户与权限 (User & Auth)
- `sys_users`: 用户ID, 用户名, 密码(加密), 角色(农户/企业/消费者/管理员), 手机号, 微信OpenID
- `sys_roles`: 角色定义表 (RBAC)

### B. 生产端 (Production)
- `base_farmlands`: 地块信息 (位置, 面积, 负责人)
- `prod_batches`: **生产批次表** (核心, 生成溯源ID), 作物名称, 种植时间, 预计采摘时间
- `prod_operations`: 农事记录 (施肥/浇水), 关联批次ID, 图片URL, 操作时间
- `prod_harvests`: 采摘记录, 关联批次ID, 数量, 等级

### C. 流通端 (Logistics)
- `logistics_orders`: 运输单号, 关联批次ID, 车辆信息, 司机
- `iot_sensors`: 传感器数据 (温度/湿度), 关联运输单, 时间戳
- `warehouse_stock`: 库存表, 入库/出库记录

### D. 质量与溯源 (Quality & Trace)
- `quality_checks`: 检测报告, 关联批次ID, 检测项, 结果(合格/不合格), 图片
- `trace_codes`: **溯源码表**, 唯一溯源ID (UUID), 关联批次ID, 生成时间, 扫码次数
- `scan_logs`: 扫码日志 (消费者扫码记录), 时间, 地点(IP/GPS)

## 3. 模块开发路线图 (Roadmap)

### 第一阶段：基础设施搭建 (预计 3-5 天)
1. **后端**: 初始化 Express 项目，配置 MySQL 连接，搭建 Sequelize/Knex ORM。
2. **数据库**: 设计并创建上述核心数据表。
3. **前端**: 引入 uView UI 库，配置统一请求拦截器 (`request.js`)，处理 JWT Token 存储。
4. **功能**: 实现 **模块1 (用户身份认证)**，完成注册、登录、角色区分逻辑。

### 第二阶段：生产端核心业务 (预计 5-7 天)
1. **功能**: 实现 **模块2 (农产品全生命周期)**。
2. **前端**: 开发表单页面（录入地块、添加农事记录、上传图片）。
3. **后端**: 实现图片上传接口，CRUD 接口。

### 第三阶段：溯源体系与二维码 (预计 3-4 天)
1. **功能**: 实现 **模块3 (溯源码生成)**。
2. **后端**: 编写算法生成唯一溯源ID，生成二维码图片或字符串。
3. **前端**: 集成扫码功能 (`uni.scanCode`)，开发 **溯源详情页** (消费者扫码后看到的H5页面)。

### 第四阶段：流通与质检 (预计 5-7 天)
1. **功能**: 实现 **模块4 (物流)** 和 **模块5 (质检)**。
2. **前端**: 开发物流轨迹时间轴组件，质检报告录入页面。
3. **后端**: 关联查询接口，确保扫码时能查出物流和质检信息。

### 第五阶段：数据可视化与消费者互动 (预计 4-5 天)
1. **功能**: 实现 **模块6 (数据统计)** 和 **模块7 (互动)**。
2. **前端**: 引入 uCharts，为管理员和企业端绘制“种植面积”、“扫码热力图”。
3. **前端**: 开发投诉反馈表单。

### 第六阶段：系统完善与测试 (预计 3 天)
1. **功能**: **模块8 (系统配置)**。
2. 全链路测试：模拟从“农户录入”到“消费者扫码”的全过程。
3. 性能优化与 Bug 修复。

## 4. 关键技术难点解决方案

1. **唯一数字身份证**: 
   - 建议使用 `UUID` 或 `Snowflake` (雪花算法) 生成不重复的 ID。
   - 数据库中建立索引，确保查询速度。

2. **图片上传**:
   - 前端使用 `uni.uploadFile`。
   - 后端使用 `multer` 中间件接收，存入 `/public/uploads` 目录，数据库存相对路径。

3. **多端适配**:
   - 溯源详情页建议优先适配 H5，因为消费者通常是用微信“扫一扫”直接打开网页，而不是进入小程序。

4. **权限控制**:
   - 后端中间件验证 Token 中的 Role 字段。
   - 前端根据 Role 动态隐藏/显示九宫格菜单。
